<main class="analysis-shell" *ngIf="game() as activeGame">
  <section class="analysis-header">
    <button mat-stroked-button type="button" routerLink="/">Back</button>
    <div>
      <h1>Game Analysis</h1>
      <p>{{ activeGame.opening || 'Unknown opening' }} · Opponent: {{ activeGame.opponent }} · {{ activeGame.result }}</p>
    </div>
  </section>

  <section class="analysis-layout">
    <mat-card class="board-card">
      <mat-card-content>
        <div #boardHost class="board-host" aria-label="Chessboard"></div>
      </mat-card-content>

      <mat-card-actions class="navigation-actions">
        <button mat-stroked-button type="button" (click)="goFirst()" [disabled]="!canGoPrevious()">First</button>
        <button mat-stroked-button type="button" (click)="goPrevious()" [disabled]="!canGoPrevious()">Previous</button>
        <button mat-stroked-button type="button" (click)="goNext()" [disabled]="!canGoNext()">Next</button>
        <button mat-stroked-button type="button" (click)="goLast()" [disabled]="!canGoNext()">Last</button>
      </mat-card-actions>

      <p class="timeline-warning" *ngIf="timelineWarning() as warning">{{ warning }}</p>

      <mat-card-footer class="board-footer">
        <span>Position {{ selectedPositionIndex() }} / {{ positionTimeline().length - 1 }}</span>
        <span>{{ moveLabel() }}</span>
      </mat-card-footer>
    </mat-card>

    <mat-card class="control-card">
      <mat-card-header>
        <mat-card-title>Move Classification</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <ng-container *ngIf="fullAnalysis() as analysis">
          <div class="analysis-meta">
            <p>Playing as: <strong>{{ analysis.playerColor }}</strong></p>
            <p>Mode: {{ analysis.analysisMode }} · Depth: {{ analysis.engineConfig.depth }}</p>
          </div>

          <ng-container *ngIf="currentClassifiedMove() as move; else initialPosition">
            <div
              class="classification-badge"
              [style.background-color]="classificationColors[move.classification]">
              <span class="classification-symbol">{{ classificationSymbols[move.classification] }}</span>
              <span class="classification-label">{{ move.classification }}</span>
            </div>

            <div class="move-detail-panel">
              <p>Move: <strong>{{ move.san }}</strong> ({{ move.piece }})</p>
              <p>{{ move.isUserMove ? 'Your move' : "Opponent's move" }}</p>
              <p *ngIf="move.bestMove">
                Best move: <strong>{{ formatBestMoveForDisplay(move.bestMove, previousFen()) }}</strong>
              </p>
              <p>Centipawn: {{ move.centipawnAfter ?? 'N/A' }}
                <span *ngIf="move.centipawnLoss > 0"> (Δ −{{ move.centipawnLoss }})</span>
              </p>
              <p>Win expectancy: {{ move.winExpectancyAfter | number:'1.1-1' }}%
                <span *ngIf="move.winExpectancyLoss > 0" class="we-loss">(−{{ move.winExpectancyLoss | number:'1.1-1' }}%)</span>
              </p>
            </div>
          </ng-container>

          <ng-template #initialPosition>
            <p class="initial-position-hint">Navigate to a move to see its classification.</p>
          </ng-template>
        </ng-container>

        <p *ngIf="!fullAnalysis()" class="error">
          No analysis data found. Please run analysis from the search page first.
        </p>
      </mat-card-content>
    </mat-card>
  </section>
</main>
