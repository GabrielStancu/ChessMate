<main class="analysis-shell" *ngIf="game() as g; else noGame">

  <!-- ══ Board column ════════════════════════════════════════════════ -->
  <div class="board-column">

    <!-- Top player bar (opponent side) -->
    <div class="player-bar">
      <span class="player-dot"
            [class.dot-white]="playerColor() === 'black'"
            [class.dot-black]="playerColor() === 'white'"></span>
      <span class="player-name">{{ playerColor() === 'white' ? g.blackPlayer : g.whitePlayer }}</span>
      <span class="player-rating">{{ playerColor() === 'white' ? g.blackRating : g.whiteRating }}</span>
    </div>

    <!-- Eval bar + board -->
    <div class="board-area">
      <app-evaluation-bar
        *ngIf="fullAnalysis()"
        [score]="currentEvaluation()"
        [playerColor]="playerColor()">
      </app-evaluation-bar>
      <div #boardHost class="board-host" aria-label="Chessboard"></div>
    </div>

    <!-- Bottom player bar (user side) -->
    <div class="player-bar">
      <span class="player-dot"
            [class.dot-white]="playerColor() === 'white'"
            [class.dot-black]="playerColor() === 'black'"></span>
      <span class="player-name">{{ playerColor() === 'white' ? g.whitePlayer : g.blackPlayer }}</span>
      <span class="player-rating">{{ playerColor() === 'white' ? g.whiteRating : g.blackRating }}</span>
    </div>

  </div>

  <!-- ══ Right analysis panel ════════════════════════════════════════ -->
  <aside class="analysis-panel">

    <!-- Panel header -->
    <div class="panel-header">
      <button class="header-icon-btn" routerLink="/" aria-label="Back to search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5M12 5l-7 7 7 7"/>
        </svg>
      </button>
      <span class="panel-title">Game Analysis</span>
      <span class="move-badge">{{ formatTimeControl(g.timeControl) }}</span>
      <span class="move-badge">{{ moveLabel() }}</span>
    </div>

    <!-- Coach panel -->
    <app-coach-panel
      [currentMove]="currentClassifiedMove()"
      [coachingLookup]="coachingLookup()"
      [batchCoachResponse]="batchCoachResponse()">
    </app-coach-panel>

    <!-- Move list — scrollable -->
    <div class="move-list-scroll" *ngIf="fullAnalysis() as analysis">
      <app-move-list
        [moves]="analysis.classifiedMoves"
        [selectedPly]="selectedPly()"
        [coachingLookup]="coachingLookup()"
        (plySelected)="onPlySelected($event)">
      </app-move-list>
    </div>

    <p *ngIf="!fullAnalysis()" class="no-analysis-hint">
      No analysis loaded. Run analysis from the search page.
    </p>

    <!-- Bottom dock -->
    <div class="panel-dock">

      <!-- Eval chart -->
      <app-evaluation-chart
        *ngIf="fullAnalysis() as analysis"
        [evaluations]="evaluationTimeline()"
        [selectedIndex]="selectedPositionIndex()"
        [classifiedMoves]="analysis.classifiedMoves"
        [playerColor]="playerColor()"
        (positionSelected)="onPlySelected($event)">
      </app-evaluation-chart>

      <!-- Navigation controls -->
      <div class="nav-controls">
        <button class="nav-btn" (click)="goFirst()" [disabled]="!canGoPrevious()" aria-label="First position">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg>
        </button>
        <button class="nav-btn" (click)="goPrevious()" [disabled]="!canGoPrevious()" aria-label="Previous move">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"/></svg>
        </button>
        <span class="nav-position">{{ selectedPositionIndex() }} / {{ positionTimeline().length - 1 }}</span>
        <button class="nav-btn" (click)="goNext()" [disabled]="!canGoNext()" aria-label="Next move">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
        </button>
        <button class="nav-btn" (click)="goLast()" [disabled]="!canGoNext()" aria-label="Last position">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18 14.5 12 6 6v12zm10-12v12h2V6z"/></svg>
        </button>
      </div>

    </div>
  </aside>

</main>

<ng-template #noGame>
  <div class="no-game-shell">
    <p>No game selected. <a routerLink="/">Return to search</a></p>
  </div>
</ng-template>
